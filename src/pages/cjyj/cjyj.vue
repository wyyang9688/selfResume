<!--  -->
<template>
    <div class="cjyjPage pages">
        <div class="pageContent1">
            <div class="logo center mt20">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    fill="none"
                    version="1.1"
                    width="52"
                    height="36"
                    viewBox="0 0 52 36"
                >
                    <g>
                        <path
                            d="M13.205,24.31Q13.595,24.31,13.82,24.67Q14.045,25.03,14.045,25.66Q14.045,26.86,13.475,27.52Q12.185,29.11,10.67,30.13Q9.155,31.15,7.235,31.15Q4.595,31.15,3.32,28.75Q2.045,26.35,2.045,22.54Q2.045,18.88,2.99,14.2Q3.935,9.52,5.78,6.16Q7.625,2.8,10.175,2.8Q11.615,2.8,12.44,4.135Q13.265,5.47,13.265,7.96Q13.265,11.53,11.285,16.24Q9.305,20.95,5.915,25.57Q6.125,26.8,6.605,27.325Q7.085,27.85,7.865,27.85Q9.095,27.85,10.025,27.145Q10.955,26.44,12.395,24.73Q12.755,24.31,13.205,24.31ZM9.515,5.77Q8.825,5.77,7.955,8.26Q7.085,10.75,6.425,14.44Q5.765,18.13,5.705,21.52Q7.835,18.01,9.095,14.485Q10.355,10.96,10.355,8.05Q10.355,5.77,9.515,5.77ZM26.915,21.79Q27.305,21.79,27.515,22.18Q27.725,22.57,27.725,23.17Q27.725,24.61,26.855,24.88Q25.055,25.51,22.895,25.6Q22.325,28.12,20.645,29.635Q18.965,31.15,16.835,31.15Q15.035,31.15,13.76,30.28Q12.485,29.41,11.825,27.97Q11.165,26.53,11.165,24.85Q11.165,22.57,12.035,20.785Q12.905,19,14.435,17.995Q15.965,16.99,17.825,16.99Q20.105,16.99,21.5,18.565Q22.895,20.14,23.135,22.45Q24.545,22.36,26.495,21.85Q26.735,21.79,26.915,21.79ZM17.075,27.97Q18.035,27.97,18.74,27.19Q19.445,26.41,19.685,24.94Q18.755,24.31,18.26,23.29Q17.765,22.27,17.765,21.13Q17.765,20.65,17.855,20.17L17.705,20.17Q16.505,20.17,15.71,21.325Q14.915,22.48,14.915,24.58Q14.915,26.23,15.56,27.1Q16.205,27.97,17.075,27.97ZM40.505,24.37Q40.895,24.37,41.12,24.745Q41.345,25.12,41.345,25.69Q41.345,26.38,41.135,26.77Q40.925,27.16,40.475,27.46Q37.895,29.2,36.695,30.04L34.775,31.33Q33.635,37.54,31.79,41.095Q29.945,44.65,27.095,44.65Q25.565,44.65,24.605,43.705Q23.645,42.76,23.645,41.23Q23.645,39.1,25.325,36.655Q27.005,34.21,31.625,30.64L31.805,29.47Q31.295,30.28,30.47,30.715Q29.645,31.15,28.835,31.15Q26.975,31.15,25.865,29.8Q24.755,28.45,24.755,26.26Q24.755,23.86,25.865,21.715Q26.975,19.57,28.82,18.265Q30.665,16.96,32.735,16.96Q33.395,16.96,33.62,17.215Q33.845,17.47,33.995,18.13Q34.565,18.01,35.315,18.01Q36.065,18.01,36.38,18.235Q36.695,18.46,36.695,19.12Q36.695,19.48,36.665,19.69Q36.545,20.62,35.915,24.4Q35.795,25.12,35.66,25.975Q35.525,26.83,35.375,27.79Q37.685,25.99,39.815,24.61Q40.205,24.37,40.505,24.37ZM29.915,28.12Q30.605,28.12,31.235,27.28Q31.865,26.44,32.135,24.88L33.095,19.75Q31.865,19.78,30.815,20.695Q29.765,21.61,29.135,23.11Q28.505,24.61,28.505,26.29Q28.505,27.22,28.88,27.67Q29.255,28.12,29.915,28.12ZM27.425,41.74Q28.175,41.74,29.12,39.94Q30.065,38.14,30.935,34.21Q28.625,36.19,27.605,37.78Q26.585,39.37,26.585,40.57Q26.585,41.08,26.78,41.41Q26.975,41.74,27.425,41.74ZM54.815,21.79Q55.205,21.79,55.415,22.18Q55.625,22.57,55.625,23.17Q55.625,24.61,54.755,24.88Q52.955,25.51,50.795,25.6Q50.225,28.12,48.545,29.635Q46.865,31.15,44.735,31.15Q42.935,31.15,41.66,30.28Q40.385,29.41,39.725,27.97Q39.065,26.53,39.065,24.85Q39.065,22.57,39.935,20.785Q40.805,19,42.335,17.995Q43.865,16.99,45.725,16.99Q48.005,16.99,49.4,18.565Q50.795,20.14,51.035,22.45Q52.445,22.36,54.395,21.85Q54.635,21.79,54.815,21.79ZM44.975,27.97Q45.935,27.97,46.64,27.19Q47.345,26.41,47.585,24.94Q46.655,24.31,46.16,23.29Q45.665,22.27,45.665,21.13Q45.665,20.65,45.755,20.17L45.605,20.17Q44.405,20.17,43.61,21.325Q42.815,22.48,42.815,24.58Q42.815,26.23,43.46,27.1Q44.105,27.97,44.975,27.97Z"
                            fill="#4F46E5"
                            fill-opacity="1"
                            style="mix-blend-mode: passthrough"
                        />
                    </g>
                </svg>
            </div>
            <div class="title">专业的简历创建工具，助你职业生涯更进一步</div>
            <div class="center">
                <div class="btn center" @click="goToResume">开始创建简历</div>
            </div>

            <div class="stitle mt30">最近编辑</div>

            <div class="listBox">
                <div
                    class="itemBox m20"
                    v-for="(item, index) in list"
                    :key="index"
                >
                    <div class="item">
                        <div class="imgBox" @click="goToEdit(item)">
                            <image
                                class="resImg sd"
                                :src="
                                    '/static/jianli/template/' +
                                    item.tempName +
                                    '.jpg'
                                "
                                mode="widthFix"
                            />
                        </div>
                        <div class="name">产品锦鲤简历</div>
                        <div class="time flex justify-between">
                            {{ item.updateTime }}编辑
                            <div
                                class="del text-red-500"
                                @click="delResume(item)"
                            >
                                删除
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- startPop -->

        <!-- endPop -->

        <!-- <gc @login="onLogin" /> -->

        <!-- <feed ref="feedRef" @receiveMsg="receiveMsg" /> -->
        <!-- <tabbar /> -->
    </div>
</template>

<script setup lang="ts">
    import tabbar from "@/components/tabbar.vue";
    import { service } from "@/http/service";
    import { toast } from "@/common/toast";
    import { useRouter } from "@/common/route";
    import { useUserStore } from "@/store/user-store";
    import { useAppStore } from "@/store/app-store";
    import { http, ajax } from "@/http/http";
    import { com } from "@/common/com";
    import { onLoad, onReachBottom, onShow } from "@dcloudio/uni-app";
    const appStore = useAppStore();
    const userStore = useUserStore();
    const { push, replace, back } = useRouter();
    const isShowTypeVisible = ref(false);
    const showTypeListPop = () => {
        isShowTypeVisible.value = true;
        uni.setStorageSync("pickSc", pickItem.value);
    };
    const list = ref<any>([]);
    const goToResume = async () => {
        const res = await service.createResume({ uid: userStore.userInfo.uid });
        if (res.code == 0) {
            push({
                url: "/pages/resume/resume?type=new&id=" + res.data.id
            });
        }
        uni.hideLoading();
    };
    const goToEdit = (item) => {
        push({
            url: "/pages/resume/resume?id=" + item.id
        });
    };
    const delResume = async (item) => {
        const res = await service.delHistoryList({
            resumeRecordId: item.id,
            delFlag: 1,
            uid: userStore.userInfo.uid
        });
        if (res.code == 0) {
            toast("删除成功");
            getHistoryList();
        }
    };
    const feedRef = ref<any>(null);
    const receiveMsg = (msg) => {
        console.log(msg);
        // push({
        //     url: "/pages/tjwx/wxzs?taskId=" + pickTaskItem.value.id
        // });
    };
    const xtList = ref<any>([]);
    const hasMore = ref(true);
    const hasLoading = ref(false);
    const total = ref(0);
    const getXTList = async (type) => {
        if (!hasMore.value && type != "init") {
            console.log("noMore");
            return;
        }
        // if (type == "init") {
        //     xtList.value = [];
        // }
        if (hasLoading.value) {
            return;
        }
        hasLoading.value = true;
        const res = await service.getXTList({
            iDisplayStart: type == "init" ? 0 : xtList.value.length,
            iDisplayLength: 15,
            hasCount: true,
            taskState: 2
        });
        hasLoading.value = false;
        uni.hideLoading();
        if (res.code == 0) {
            if (type == "init") {
                total.value = res.size;
                xtList.value = res.data || [];
                if (xtList.value.length) {
                    if (userStore.userInfo.accInfo!.isCollectinsFlag) {
                        nextTick(() => {
                            feedRef.value.openPop();
                        });
                        return;
                    }
                }
            } else {
                xtList.value = xtList.value.concat(res.data);
                total.value = res.size;
            }
        }
        if (res.size <= xtList.value.length) {
            hasMore.value = false;
        } else {
            hasMore.value = true;
        }
    };
    onShow(() => {
        //
    });
    const clickClose = () => {
        isShowTypeVisible.value = false;
    };
    const isShowHellowVisible = ref(false);
    const typeList = ref([
        {
            name: "课程论文",
            key: "0",
            isPick: true,
            info: "课程论文一般为3000-5000字，学术挑战性适中"
        },
        {
            name: "开题报告",
            key: "1",
            isPick: false,
            info: "开题报告一般为8000-1.2万字，有一定学术挑战性"
        },
        {
            name: "发表论文",
            key: "2",
            isPick: false,
            info: "发表论文一般为1.2万-1.5万字，学术挑战性较高"
        }
    ]);
    const pickItem = computed(() => {
        return typeList.value.find((v) => v.isPick);
    });
    const clickTypeList = (item: any) => {
        for (let v of typeList.value) {
            v.isPick = false;
        }
        item.isPick = true;
        uni.setStorageSync("pickSc", pickItem.value);
    };
    const kw = ref("");
    const clickSearch = () => {
        console.log(kw.value);
        showTypeListPop();
    };
    const goSearch = () => {
        if (!kw.value) {
            toast("请输入关键词");
            return;
        }
        ajax.post("/school/info/api/task/save", {
            taskmsg: {
                uid: userStore.userInfo.uid,
                topicName: kw.value,
                target: pickItem?.value?.key,
                completeTime: com.format(
                    new Date(new Date()),
                    "YYYY-MM-DD hh:mm:ss"
                )
            }
        }).then((res: any) => {
            console.log(res);
            if (res.data.code == 0) {
                //   this.$message.success('选题创建成功')
                //   this.$emit('receiveMsg', {
                //     key: 'updateScList',
                //     id: res.data
                //   })
                isShowTypeVisible.value = false;
                uni.setStorageSync("XT", kw.value);
                push({
                    url: "/pages/tjwx/tjwx?taskId=" + res.data.data
                });
            } else {
                toast(res.data.msg);
            }
        });
    };
    const query = ref<any>();
    onLoad((op: any) => {
        query.value = op;
        console.log("queryOptions");
        console.log(query.value);
        com.cs("queryOptions");
        com.cs(query.value);
        uni.setNavigationBarTitle({
            title: ""
        });
    });
    const eid = ref("");
    const extensionCode = ref("");
    onMounted(async () => {
        //
        let pn = "";
        try {
            uni.showLoading({
                mask: true
            });
            setTimeout(() => {
                uni.hideLoading();
            }, 2000);
            com.onMsg((e: any) => {
                if (e.pn) {
                    pn = e.pn;
                    eid.value = e.eid || "";
                    extensionCode.value = e.extensionCode || "";
                    login(pn);
                } else if (!e.pn) {
                    com.sendMsg("reLogin");
                }
                if (e.oid) {
                    userStore.setKeyVal({ key: "oid", val: e.oid });
                }
            });

            com.sendMsg("pn");
        } catch (e) {
            console.log(e);
        }
        if (location.href.includes("localhost") && !pn) {
            login("15348401122");
            // login("13647494174");
        }
    });
    const getHistoryList = async () => {
        const res = await service.getHistoryList({
            uid: userStore.userInfo.uid
        });
        if (res.code == 0) {
            list.value = res.data.map((v) => {
                return {
                    ...v,
                    updateTime: com.format(
                        v.updateTime || v.createTime,
                        "YYYY-MM-DD"
                    )
                };
            });
        }
    };
    const login = async (pn: string) => {
        const res = await service.loginIn({
            pn,
            mode: 30,
            loginstr: 0,
            eid: eid.value,
            extensionCode: extensionCode.value
        });
        uni.hideLoading();
        if (res.code == 0) {
            userStore.set_user_info(res.data as any);

            appStore.set_Token(
                "local_token",
                res.data.uid + "" + res.data.security
            );
            appStore.changeLoginState(true);
            if (res.data.accInfo?.isNewUser) {
                isShowHellowVisible.value = true;
                isShareFlag.value = false;
                appStore.changeGc(true);
            }
            // if (!res.data.accInfo?.itschoolId) {
            //     appStore.changeGc(true);
            // }
            setTimeout(() => {
                if (
                    res.data.uid + "" + res.data.security ==
                    uni.getStorageSync("local_token")
                )
                    getXTList("init");
            }, 500);
            getHistoryList();
        }
    };
    const isShareFlag = ref(false);
    const onLogin = (e: any) => {
        console.log("saveInfo");
        console.log(e);
        if (e.isShareFlag) {
            isShowHellowVisible.value = true;
            isShareFlag.value = true;
        }
    };
</script>
<style lang="scss" scoped>
    .cjyjPage {
        padding-bottom: 140rpx;
        .pageContent1 {
            > .title {
                font-family: Roboto;
                font-size: 14px;
                font-weight: normal;
                line-height: 21px;
                text-align: center;
                letter-spacing: 0px;
                color: #4b5563;
            }
            .btn {
                width: 686rpx;
                height: 106rpx;
                /* 自动布局 */
                display: flex;
                flex-direction: column;
                padding: 32rpx 0rpx;
                gap: 0rpx 20rpx;
                flex-wrap: wrap;
                border-radius: 8rpx;
                opacity: 1;
                background: #4f46e5;
                color: #fff;
                margin-top: 64rpx;
            }
            > .stitle {
                font-family: Roboto;
                font-size: 36rpx;
                font-weight: bold;
                line-height: 56rpx;
                letter-spacing: 0px;
                color: #000000;
                margin-left: 32rpx;
            }
            .listBox {
                padding: 0 36rpx;
                display: flex;
                flex-wrap: wrap;
                .itemBox {
                    width: 334rpx;
                    .item {
                        padding: 20rpx;
                        .imgBox {
                            border-radius: 20.87rpx;
                            overflow: hidden;
                            background: #a5a5a5;
                            width: 100%;
                            padding: 30rpx;
                            .resImg {
                                border-radius: 20.87rpx;
                            }
                        }
                        .name {
                            margin-top: 20rpx;
                            font-family: Roboto;
                            font-size: 24.35rpx;
                            font-weight: bold;
                            line-height: 34.78rpx;
                            letter-spacing: 0px;
                            color: #000000;
                        }
                        .time {
                            font-family: Roboto;
                            font-size: 20.87rpx;
                            font-weight: normal;
                            line-height: 27.82rpx;
                            letter-spacing: 0px;
                            color: #6b7280;
                        }
                    }
                }
            }
        }
        .clearModal {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            z-index: 600;
            // background: rgba(0, 0, 0, 0.7);
            .outerBox {
                position: absolute;
                top: 184 * 2rpx;
                left: 0rpx;

                padding: 50rpx 40rpx;
                width: 100%;
                .innerBox {
                    .container {
                        position: relative;
                        background-color: #fff;
                        width: 252 * 2rpx;
                        height: 170 * 2rpx;
                        border-radius: 30rpx;
                        border: 1px solid #333;
                        padding: 26 * 2rpx 20 * 2rpx;
                        .close {
                            position: absolute;
                            right: 10rpx;
                            top: 10rpx;
                            z-index: 800rpx;
                        }
                        .title {
                            padding: 5 * 2rpx 10 * 2rpx;
                            text-align: left;
                            border-bottom: 1px solid #a1824a;
                        }
                        .list {
                            display: flex;
                            justify-content: space-between;
                            padding: 0 13 * 2rpx;
                            .item {
                                padding: 4 * 2rpx 7 * 2rpx;
                                border: 1px solid #a6a6a6;
                                border-radius: 10 * 2rpx;
                            }
                        }
                        .info {
                            padding: 0 10 * 2rpx;
                        }
                        .btn {
                            color: #fff;
                            min-width: 84 * 2rpx;
                            height: 20 * 2rpx;
                            line-height: 20 * 2rpx;
                            border-radius: 30rpx;
                        }
                    }
                }
            }
        }
        .hylb {
            background-color: rgba(1, 1, 1, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0 20 * 2rpx;
            display: flex;
            justify-content: center;
            .box {
                width: 325 * 2rpx;
                height: 460 * 2rpx;
                background-color: #fff;
                margin-top: 60 * 2rpx;
                border-radius: 15 * 2rpx;
                padding: 0 16 * 2rpx;
                padding-bottom: 30 * 2rpx;
                padding-top: 50 * 2rpx;
                position: relative;
                .close {
                    position: absolute;
                    right: 10 * 2rpx;
                    top: 10 * 2rpx;
                }
                .msg {
                    color: #666666;
                }
                .hello {
                    margin-top: 3 * 2rpx;
                }
                > .ci {
                    color: #666666;
                }
                .dv {
                    .dv {
                        height: 1 * 2rpx;
                        background: #d9d9d9;
                    }
                }
                .row {
                    background-color: #f5f7fa;
                    padding: 12 * 2rpx 16 * 2rpx;
                    border-radius: 8 * 2rpx;
                    .lf {
                        .resImg {
                            width: 40 * 2rpx;
                            height: 40 * 2rpx;
                        }
                    }
                    .title {
                        color: #333;
                    }
                    .fg {
                        flex-grow: 1;
                        text-align: left;
                        align-items: flex-start;
                    }
                    .count {
                        color: #999999;
                    }
                }
                .gbtn {
                    background-color: #009963;
                    color: #fff;
                    height: 44 * 2rpx;
                }
            }
        }
    }
</style>
